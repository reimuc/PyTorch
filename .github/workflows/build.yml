name: Build PyTorch ROCm

on:
  workflow_dispatch:
    inputs:
      rocm_nightly_version:
        description: 'ROCm SDK nightly version'
        required: true
        default: '7.12.0a20260122'
      pytorch_version:
        description: 'ROCm pytorch release version'
        required: true
        default: "release/2.10"

jobs:
  build_pytorch_rocm:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      DVC_NO_ANALYTICS: "1"
      BUILD_ROOT: D:\build
      TEMP: D:\temp
      TMP: D:\temp
      PIP_CACHE_DIR: D:\pip-cache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git (longpaths/symlinks)
        shell: powershell
        run: |
          git config --global core.longpaths true
          git config --global core.symlinks true
          Get-PSDrive -PSProvider FileSystem | Format-Table -AutoSize

      - name: Prepare Python environment
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          python -m pip install packaging dvc dvc-s3

      - name: Download and install AMD ROCm SDK wheels
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $version = "${{ github.event.inputs.rocm_nightly_version }}"
          $channel = "v2-staging"
          $archDir = "gfx103X-dgpu"
          $baseUrl = "https://rocm.nightlies.amd.com/$channel/$archDir"

          New-Item -ItemType Directory -Path "$env:BUILD_ROOT\rocm-sdk" -Force | Out-Null
          Set-Location "$env:BUILD_ROOT\rocm-sdk"

          function Download-File($url, $outFile) {
            Write-Host "Downloading: $url"
            curl.exe -L --fail --retry 10 --retry-delay 2 --retry-all-errors -C - `
              -o $outFile $url
          }

          $metaFile   = "rocm-$version.tar.gz"
          $coreFile   = "rocm_sdk_core-$version-py3-none-win_amd64.whl"
          $develFile  = "rocm_sdk_devel-$version-py3-none-win_amd64.whl"
          $libsFile   = "rocm_sdk_libraries_gfx103x_dgpu-$version-py3-none-win_amd64.whl"

          Download-File "$baseUrl/$metaFile"  $metaFile
          Download-File "$baseUrl/$coreFile"  $coreFile
          Download-File "$baseUrl/$develFile" $develFile
          Download-File "$baseUrl/$libsFile"  $libsFile

          python -m pip install --no-deps .\$metaFile
          python -m pip install .\$coreFile
          python -m pip install .\$develFile
          python -m pip install .\$libsFile

      - name: Prepare TheRock external_build/pytorch helper
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          cd "$env:BUILD_ROOT"
          git clone https://github.com/ROCm/TheRock.git
          cd "$env:BUILD_ROOT\TheRock"

          python -m pip install -r requirements.txt
          python .\build_tools\fetch_sources.py

      - name: Checkout PyTorch / Audio / Vision (ROCm fork)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          cd "$env:BUILD_ROOT\TheRock\external-builds\pytorch"

          $TorchRoot = "$env:BUILD_ROOT\pytorch"
          New-Item -ItemType Directory -Path $TorchRoot -Force | Out-Null
          $TorchDir  = Join-Path $TorchRoot "pytorch"
          $AudioDir  = Join-Path $TorchRoot "audio"
          $VisionDir = Join-Path $TorchRoot "vision"

          $TorchRepoOrigin = "https://github.com/ROCm/pytorch.git"
          $TorchHashtag    = "${{ github.event.inputs.pytorch_version }}"

          python .\pytorch_torch_repo.py checkout --repo-hashtag $TorchHashtag --gitrepo-origin $TorchRepoOrigin --checkout-dir $TorchDir
          python .\pytorch_audio_repo.py checkout --require-related-commit --checkout-dir $AudioDir --torch-dir $TorchDir
          python .\pytorch_vision_repo.py checkout --require-related-commit --checkout-dir $VisionDir --torch-dir $TorchDir

      - name: Setup MSVC dev environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Build PyTorch ROCm wheels
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          cd "$env:BUILD_ROOT\TheRock\external-builds\pytorch"

          $TorchRoot = "$env:BUILD_ROOT\pytorch"
          $TorchDir  = Join-Path $TorchRoot "pytorch"
          $AudioDir  = Join-Path $TorchRoot "audio"
          $VisionDir = Join-Path $TorchRoot "vision"

          $OutDir = "$env:BUILD_ROOT\pytorch_rocm_out"
          New-Item -ItemType Directory -Path $OutDir -Force | Out-Null

          python .\build_prod_wheels.py build `
            --pytorch-dir $TorchDir `
            --pytorch-audio-dir $AudioDir `
            --pytorch-vision-dir $VisionDir `
            --output-dir $OutDir `
            --clean

      - name: Upload PyTorch ROCm wheels
        uses: actions/upload-artifact@v4
        with:
          name: pytorch-rocm-wheels-gfx103X-${{ github.event.inputs.rocm_nightly_version }}-${{ github.event.inputs.pytorch_version }}
          path: $env:BUILD_ROOT\pytorch_rocm_out
