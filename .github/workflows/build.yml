name: Build PyTorch ROCm

on:
  workflow_dispatch:
    inputs:
      rocm_nightly_version:
        description: 'ROCm SDK nightly version'
        required: true
        default: '7.11.0a20260120'
      pytorch_version:
        description: 'ROCm pytorch release version'
        required: true
        default: "release/2.10"

jobs:
  build_pytorch_rocm:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      DVC_NO_ANALYTICS: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git (longpaths/symlinks)
        shell: powershell
        run: |
          git config --global core.longpaths true
          git config --global core.symlinks true

      - name: Prepare Python environment
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          python -m pip install packaging dvc dvc-s3

      - name: Download and install AMD ROCm SDK wheels
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $version = "${{ github.event.inputs.rocm_nightly_version }}"
          $channel = "v2-staging"
          $archDir = "gfx103X-dgpu"
          $baseUrl = "https://rocm.nightlies.amd.com/$channel/$archDir"

          New-Item -ItemType Directory -Path C:\rocm-sdk -Force | Out-Null
          Set-Location C:\rocm-sdk

          function Download-File($url, $outFile) {
            Write-Host "Downloading: $url"
            # -L 跟随跳转
            # --fail 遇到 4xx/5xx 直接失败
            # --retry-all-errors + --retry 自动重试
            # -C - 断点续传
            curl.exe -L --fail --retry 10 --retry-delay 2 --retry-all-errors -C - `
              -o $outFile $url
          }

          $coreFile   = "rocm_sdk_core-$version-py3-none-win_amd64.whl"
          $develFile  = "rocm_sdk_devel-$version-py3-none-win_amd64.whl"
          $libsFile   = "rocm_sdk_libraries_gfx103x_dgpu-$version-py3-none-win_amd64.whl"

          Download-File "$baseUrl/$coreFile"  $coreFile
          Download-File "$baseUrl/$develFile" $develFile
          Download-File "$baseUrl/$libsFile"  $libsFile

          python -m pip install .\$coreFile
          python -m pip install .\$develFile
          python -m pip install .\$libsFile

      - name: Prepare TheRock external_build/pytorch helper
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          cd C:\
          git clone https://github.com/ROCm/TheRock.git
          cd C:\TheRock

          python -m pip install -r requirements.txt
          python .\build_tools\fetch_sources.py

      - name: Checkout PyTorch / Audio / Vision (ROCm fork)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          cd C:\TheRock\external-builds\pytorch

          $TorchRoot = "C:\pytorch"
          New-Item -ItemType Directory -Path $TorchRoot -Force | Out-Null
          $TorchDir  = Join-Path $TorchRoot "pytorch"
          $AudioDir  = Join-Path $TorchRoot "audio"
          $VisionDir = Join-Path $TorchRoot "vision"

          $TorchRepoOrigin = "https://github.com/ROCm/pytorch.git"
          $TorchHashtag    = "${{ github.event.inputs.pytorch_version }}"

          python .\pytorch_torch_repo.py checkout --repo-hashtag $TorchHashtag --gitrepo-origin $TorchRepoOrigin --checkout-dir $TorchDir
          python .\pytorch_audio_repo.py checkout --require-related-commit --checkout-dir $AudioDir --torch-dir $TorchDir
          python .\pytorch_vision_repo.py checkout --require-related-commit --checkout-dir $VisionDir --torch-dir $TorchDir

      - name: Build PyTorch ROCm wheels
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          cd C:\TheRock\external-builds\pytorch

          $TorchRoot = "C:\pytorch"
          $TorchDir  = Join-Path $TorchRoot "pytorch"
          $AudioDir  = Join-Path $TorchRoot "audio"
          $VisionDir = Join-Path $TorchRoot "vision"

          $OutDir = "C:\pytorch_rocm_out"
          New-Item -ItemType Directory -Path $OutDir -Force | Out-Null

          python .\build_prod_wheels.py build `
            --pytorch-dir $TorchDir `
            --pytorch-audio-dir $AudioDir `
            --pytorch-vision-dir $VisionDir `
            --output-dir $OutDir `
            --clean

      - name: Upload PyTorch ROCm wheels
        uses: actions/upload-artifact@v4
        with:
          name: pytorch-rocm-wheels-gfx103X-${{ github.event.inputs.rocm_nightly_version }}-${{ github.event.inputs.pytorch_version }}
          path: C:\pytorch_rocm_out
